name: Codacy Coverage

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Use Node.js
        uses: actions/setup-node@main
        with:
          node-version: "20"

      - name: Set environment variables
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS_BASE64 = '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_BASE64 }}'" >> .env
          echo "FIREBASE_API_KEY = '${{ secrets.FIREBASE_API_KEY }}'" >> .env
          echo "FIREBASE_AUTH_DOMAIN = '${{ secrets.FIREBASE_AUTH_DOMAIN }}'" >> .env
          echo "FIREBASE_PROJECT_ID = '${{ secrets.FIREBASE_PROJECT_ID }}'" >> .env
          echo "FIREBASE_STORAGE_BUCKET = '${{ secrets.FIREBASE_STORAGE_BUCKET }}'" >> .env
          echo "FIREBASE_MESSAGING_SENDER_ID = '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}'" >> .env
          echo "FIREBASE_APP_ID = '${{ secrets.FIREBASE_APP_ID }}'" >> .env

      - name: Install dependencies
        run: npm ci

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Run tests with coverage
        run: firebase use tfg-nico-ruben && firebase emulators:exec 'npm test' -P tfg-nico-ruben

      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/lcov.info
